name: CI

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: lukaszkostka/avr:debian_buster
      env:
        CXX: avr-g++
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      - name: Run cmake
        run: >
          cmake
          -DF_CPU=11059200
          -DBAUD=115200
          -DCMAKE_BUILD_TYPE=MinSizeRel
          -DMCU=atmega32
          -DAVR_PROGRAMMER=stk500v2
          -DAVR_PROGRAMMER_BAUD=112500
          -DAVR_PROGRAMMER_PORT=/dev/null
          -H.
          -GNinja
          -Bbuild
      - name: Build
        run: ninja -C build
  test:
    runs-on: ubuntu-latest
    container:
      image: lukaszkostka/avr:alpine_3.10
      env:
        CXX: clang++
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      - name: Run cmake
        run: >
          cmake
          -DF_CPU=11059200
          -DBAUD=115200
          -DMCU=atmega32
          -DBUILD_TESTS=ON
          -DAVR_PROGRAMMER=stk500v2
          -DAVR_PROGRAMMER_BAUD=112500
          -DAVR_PROGRAMMER_PORT=/dev/null
          -H.
          -GNinja
          -Bbuild
      - name: Build
        run: ninja -C build tests
      - name: Run tests
        run: build/tests
